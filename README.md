[TOC]

Introduction
===========

Turn your raspberry (or any linux box) into a wireless hotspot to allow your guests to register before accessing your Wifi at home.

A captive portal is run on an ad-hoc guest network as a wifi usb dongle is plugged into the system. 
Users are then requested for an OTP code that you can generate on your phone. 
Once registered, the MAC address of the guest's device is added to the router's whitelist.

You can allow the device accessing for a configurable number of days after which it will be revoked automatically.

Why OTPspot?
---------------------
I have a standard DSL router at home with WPA2-PSK and I wanted to do something to somehow enhance the security of my wireless network. Moving to 802.1x and radius is not an option since a I have a few legacy devices not supporting that mechanism so I had to stay with WPA2-PSK and a shared password. I then decided to enable MAC address filtering so to allow only my managed devices to access the network. But when I have guests at home the problem becomes retrieving the MAC addresses of their devices and adding them manually to my TP-Link router. Not very handy.

So I thought I needed some sort of captive portal to allow some sort of automatic registration and the easiest way I found was to turn a wifi USB dongle connected to the raspberry into a "guest", isolated wireless network and having the devices connected to it redirected to my capitve portal for registration before connecting them to the main wifi.

How it works
---------------------

As a wifi usb donge is plugged on the raspberry, the application is run. 
"hostapd" is executed to turn the dongle into an access point so to allow guests to connect to it and firewall rules are added to redirect all the traffic of the users connecting to that network to the captive portal before a minimal web server hosting the captive portal is stared.

Once a user connects to the guest wireless network, the device will detect additional credentails are required and present the user with the captive portal. The user is requested a description of the device and an OTP code the host will provide. This code is generated by the Google Authenticator app running on the host's phone and aligned with a "service" user on the raspberry used to validate the authentication. 

Once a valid OTP is provided the application add the device to the router's MAC address filtering whitelist. You can now connect the device to the main wifi network.

So far a single plugin for interacting with a router is provided and it is based on my tp-link TD-W8970. If you have a different router you may want to write your own plugin implementing the following methods:

- add(<description>,<mac_address>,<expire_days>): to add a new device and set an expiration date. The expiration date is supposed to be coded inside the name so the expire method can run without additional input
- delete(<description): revoke access to a given device
- expire(): revoke access to those devices whose expiration date is passed by

Installation
===========
- Create a directory of your choice and transfer all the files of the package
- As root, run the install.py script. This will install all the required dependencies, the init and the pam services.
- Download, compile and install Google Authenticator from https://github.com/google/google-authenticator
- Create a user (e.g. adduser otpspot) and set it a valid password
- Become that user (e.g. su otpspot)
- Run google-authenticator
- On your phone, install Google Authenticator from the app store
- Scan the bar code on the screen to allow Google Authenticator on your phone to generate valid OTP
- If you wish to run the portal only when the Wifi USB dongle is plugged, add in the wlan0 section of /etc/network/interfaces:
  -post-up /etc/init.d/otpspot start
  -post-down /etc/init.d/otpspot stop
- If you wish to have the portal always running, run as root: update-rc.d otpspot defaults
- Rename the config-example.py file in config.py and edit it
- Set the INTERFACE, PORT and IP variables on top of /etc/init.d/otpspot
- Customize the SSID of the guest network in /etc/hostapd/hostapd.conf
- Ensure you have a DHCP server configured for that network

Configuration
===========
- Copy the config-example.py file into a file named config.py
- Open config.py and edit the settings

